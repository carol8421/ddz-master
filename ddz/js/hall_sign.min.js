var GIFT_NAME=["记牌器×2","超级加倍×3","连胜符×3","道具包","得分加成×3"];var userInfo={activeTimes:0,type:1,todayActive:false,codeList:[],dbWelfareActive:false,isVoted:false,step:0};var getLocalUserInfo=function(a){$.ajax({url:mainUrl+signApiUrl.getInfo,type:"GET",data:{uin:uin},dataType:"json",success:function(b){console.log(b);if(b.code===0){userInfo={activeTimes:b.data.today_info.received?b.data.today_info.day:b.data.today_info.day-1,type:b.data.today_info.received?b.data.today_info.info.type:b.data.today_info.day,todayActive:b.data.today_info.received,codeList:b.data.last_7days_info,dbWelfareActive:b.data.pk_video_prize,isVoted:b.data.today_like_pk_video,time:new Date(b.data.time*1000).Format("yyyyMMdd")};sessionStorage.setItem("pk_video_prize",userInfo.dbWelfareActive);for(var c=0;c<userInfo.activeTimes;c++){$(".sign-home .block").eq(c).addClass("active");if(c==2){$(".sign-home .block").eq(c).addClass("cur_"+parseInt(userInfo.type+1))}}if(!userInfo.todayActive&&userInfo.activeTimes!=3){$(".sign-home .block").eq(userInfo.activeTimes).addClass("normal")}else{$(".getGift").addClass("disable");$(".getGift").addClass("normal")}$(".sign-record ul").empty();if(userInfo.codeList.length>0){for(var c=0;c<userInfo.codeList.length;c++){$(".sign-record ul").append('<li class="w2"><time>'+new Date(userInfo.codeList[c].time*1000).Format("yyyy/M/d hh:mm")+"</time><code>"+userInfo.codeList[c].cdkey+'</code><button class="copy" data-clipboard-text="'+userInfo.codeList[c].cdkey+'">复制</button></li>')}}else{$(".sign-record ul").append("<span>暂无记录</span>")}var d=new Clipboard(".copy");d.on("success",function(f){CommonJS.Toast("复制成功")});d.on("error",function(f){CommonJS.Toast("长按兑换码选择复制")});a?a():function(){}}else{CommonJS.Toast(b.msg)}},error:function(b){if(b.status!==0){CommonJS.Toast("用户初始化接口异常")}else{CommonJS.Toast("请刷新重试")}}})};var countDown=false;if(new Date().getFullYear()===2018&&new Date().getMonth()===0&&!sessionStorage.getItem("opendiv")){if(new Date().getDate()===17||new Date().getDate()===18||new Date().getDate()===19||new Date().getDate()===20||new Date().getDate()===26){countDown=true;var img=document.createElement("img");img.alt="倒计时";switch(new Date().getDate()){case 17:img.src="./images/open/l-3.png";break;case 18:img.src="./images/open/l-2.png";break;case 19:img.src="./images/open/l-1.png";break;case 20:img.src="./images/open/l-0.png";break;case 26:img.src="./images/open/5.png";break}document.getElementsByClassName("opendiv")[0].appendChild(img);sessionStorage.setItem("opendiv",true)}}if(uin){getLocalUserInfo(function(){if(userInfo.dbWelfareActive===1){$(".signBtn").addClass("icon-get");!countDown&&$(".pk-box").show()}else{if(!userInfo.todayActive){$(".signBtn").addClass("icon-login");!countDown&&$(".sign-home").show()}}if(countDown){$(".sign").show();$(".opendiv").show();$(".sign-aside").addClass("show")}else{if(CommonJS.getCookie("ddz_login_"+userInfo.time+"_"+uin)){$(".sign-aside").addClass("show")}else{$(".sign").show()}}CommonJS.setCookie("ddz_login_"+userInfo.time+"_"+uin,true,1)})}var msgSended=false;var jsCreated=false;var getSend=function(b){var a={callback:c,showHeader:true};capInit(document.getElementById("TCaptcha"),a);document.getElementById("TCaptcha").style.display="block";function c(d){document.getElementById("TCaptcha").style.display="none";if(d.ret==0){getMsg(d.ticket,b)}else{CommonJS.Toast("验证失败");msgSended=false}}};$(".getCode").on("click",function(){if(msgSended){return}var a=document.getElementById("phone");if(a.value==null||a.value==""||!(/^1[3|4|5|7|8]\d{9}$/.test(a.value))){CommonJS.Toast("请输入正确的手机号码")}else{if(jsCreated){getSend(a.value)}else{$.ajax({url:hostUrl+signApiUrl.getJsUrl,type:"GET",data:{client_type:1},dataType:"json",beforeSend:function(){msgSended=true},success:function(b){if(b.code===0){CommonJS.CreateScript(b.data.url,function(){jsCreated=true;getSend(a.value)})}else{CommonJS.Toast(b.msg);msgSended=false}},error:function(b){if(b.status!==0){CommonJS.Toast("获取验证码JS接口异常")}else{CommonJS.Toast("请刷新重试")}msgSended=false}})}}});function getMsg(b,a){$.ajax({url:hostUrl+signApiUrl.getMsg,type:"GET",data:{ticket:b,phonenum:a},dataType:"json",success:function(c){if(c.code===0){CommonJS.Toast("请注意查收短信");$(".getCode").addClass("disable");var e=60;var d=setInterval(function(){if(e<=0){$(".getCode").removeClass("disable");$(".getCode").text("重新发送");msgSended=false;clearInterval(d)}else{e-=1;$(".getCode").text("重新发送("+e+")")}},1000)}else{CommonJS.Toast(c.msg);msgSended=false}},error:function(c){if(c.status!==0){CommonJS.Toast("获取短信接口异常")}else{CommonJS.Toast("请刷新重试")}msgSended=false}})}var fromButton=1;$(".login").on("click",function(){var a=document.getElementById("phone");var b=document.getElementById("msgCode");if(!uin){CommonJS.Toast("请前往斗地主直播间登录领取")}else{if(a.value==null||a.value==""||!(/^1[3|4|5|7|8]\d{9}$/.test(a.value))){CommonJS.Toast("请输入正确的手机号码")}else{if(b.value==null||b.value==""){CommonJS.Toast("请输入短信验证码")}else{$.ajax({url:mainUrl+signApiUrl.login,type:"GET",data:{uin:uin,phone:a.value,captcha:b.value},dataType:"json",success:function(e){if(e.code===0){var d=new Object();d.uin=uin;d.TOKEN=e.data.token;TOKEN=d.TOKEN;var c=[];if(localStorage.user!=undefined&&localStorage.user!="undefined"&&localStorage.user){c=JSON.parse(localStorage.user)}c.push(d);localStorage.user=JSON.stringify(c);$(".sign-login").hide();if(fromButton===1){getGiftB()}else{getLocalUserInfo(function(){getGift()})}}else{CommonJS.Toast(e.msg)}},error:function(c){if(c.status!==0){CommonJS.Toast("登录接口异常")}else{CommonJS.Toast("请刷新重试")}}})}}}});var getGift=function(){$.ajax({url:mainUrl+signApiUrl.sign,type:"GET",data:{uin:uin,token:TOKEN},dataType:"json",success:function(b){if(b.code===0){userInfo.activeTimes=userInfo.activeTimes+1;userInfo.type=b.data.cdkey_type;userInfo.todayActive=true;userInfo.code=b.data.cdkey;userInfo.step=1;$(".sign").show();$(".sign-home").hide();$(".sign .main-page.sign-home .sMain .block").eq(userInfo.activeTimes-1).removeClass("normal").addClass("active");if(userInfo.activeTimes==3){$(".sign .main-page.sign-home .sMain .block").eq(userInfo.activeTimes-1).addClass("cur_"+parseInt(userInfo.type+1))}$(".getGift").addClass("disable");var d="";d+='<div class="gift"><i style="background-image: url(./images/sign/g-'+userInfo.type+'.png)"></i><p>'+GIFT_NAME[userInfo.type-1]+"</p></div><code><span>"+userInfo.code+"</span>";d+='<button class="copy" data-clipboard-text="'+userInfo.code+'">复制</button></code><p>点击复制兑换码，在直播大厅“cdkey兑换”中兑换</p>';if(userInfo.codeList.length==0){$(".sign-record ul span").remove()}$(".sign-record ul").prepend('<li class="w2"><time>'+new Date().Format("yyyy/M/d hh:mm")+"</time><code>"+userInfo.code+'</code><button class="copy" data-clipboard-text="'+userInfo.code+'">复制</button></li>');if(!userInfo.todayActive&&userInfo.activeTimes!=3){$(".sign-home .block").eq(userInfo.activeTimes).addClass("normal")}if($(".sign-box .gift")){$(".sign-box .gift,.sign-box code,.sign-box p").remove()}$(".sign-box .light").after(d);$(".sign-box").show();$(".signBtn").removeClass("icon-login");var e=new Clipboard(".copy");e.on("success",function(f){CommonJS.Toast("复制成功")});e.on("error",function(f){CommonJS.Toast("长按兑换码选择复制")});_hmt.push(["_trackEvent","斗地主直播间-首页","成功领取","登录奖励",1]);_czc.push(["_trackEvent","斗地主直播间-首页","登录奖励","成功领取",0,"gift"])}else{if(b.code==100005||b.code==100008||b.code==20000||b.code==20003||b.code==20006){$(".sign-home").hide();$(".sign-login").show();var a=JSON.parse(localStorage.user);for(var c in a){if(a[c].TOKEN==TOKEN){a.splice(c,1)}}localStorage.user=JSON.stringify(a)}else{CommonJS.Toast(b.msg)}}},error:function(a){if(a.status!==0){CommonJS.Toast("登录领奖接口异常")}else{CommonJS.Toast("请刷新重试")}}})};$(".getGift").on("click",function(){fromButton=2;if($(this).hasClass("disable")){CommonJS.Toast("今日已领取");return}if(!uin){CommonJS.Toast("请前往斗地主直播间登录领取")}else{if(TOKEN==null||TOKEN==""){$(".sign-home").hide();$(".sign,.sign-login").show()}else{getGift()}}_hmt.push(["_trackEvent","斗地主直播间-首页","点击","登录领取",1]);_czc.push(["_trackEvent","斗地主直播间-首页","登录领取","点击",0,"getGift"])});$(".getRecord").on("click",function(){$(".sign-home").hide();$(".sign-record").show()});$(".close").on("click",function(){if($(this).hasClass("back")&&userInfo.step===2){$(".global-box").hide();$(".sign-home").show()}else{$(".sign, .global-box").hide();$(".sign-aside").addClass("show")}});$(".signBtn").on("click",function(){if($(this).hasClass("icon-get")){$(".sign, .pk-box").show();$(".sign-aside").removeClass("show");_hmt.push(["_trackEvent","斗地主直播间-首页","点击","领取奖励",1]);_czc.push(["_trackEvent","斗地主直播间-首页","领取奖励","点击",0,"signBtn"])}else{if($(this).hasClass("icon-login")){$(".sign, .sign-home").show();$(".sign-aside").removeClass("show");_hmt.push(["_trackEvent","斗地主直播间-首页","点击","登录有礼",1]);_czc.push(["_trackEvent","斗地主直播间-首页","登录有礼","点击",0,"signBtn"])}else{$(".sign, .sign-record").show();$(".sign-aside").removeClass("show");_hmt.push(["_trackEvent","斗地主直播间-首页","点击","查看奖励",1]);_czc.push(["_trackEvent","斗地主直播间-首页","查看奖励","点击",0,"signBtn"])}}});$(".sign-aside .close").on("click",function(){$(".sign-aside").removeClass("show")});