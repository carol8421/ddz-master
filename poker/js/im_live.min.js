var appKey="p5tvi9dstt364";RongIMClient.init(appKey);var token=v.im_token;var conversationtype=RongIMLib.ConversationType.CHATROOM;var chatroomId=v.objectId;var random=Math.floor(Math.random()*900000+100000);var sendTimes=0;var cookie_nickname=decodeURI(localStorage.Nick)||getQueryString("Nick");var cookie_avatar=getQueryString("avatar");var times=0;var localUid=null;var merit=function(a,b){return a!="undefined"&&a!=null&&a!=""?a:b};var connectError=function(a){tips(a)};var AbnormalMode=function(){pgc.parentNode.removeChild(pgc);giftContainer.parentNode.removeChild(giftContainer);zanContainer.parentNode.removeChild(zanContainer);dmContainer.parentNode.removeChild(dmContainer)};RongIMClient.connect(token,{onSuccess:function(a){localUid=a;console.log("Login successfully."+a);RongIMClient.getInstance().joinChatRoom(chatroomId,0,{onSuccess:function(){},onError:function(b){console.log(b)}})},onTokenIncorrect:function(){console.log("token无效");debugMsg="token无效";AbnormalMode()},onError:function(b){var a="";switch(b){case RongIMLib.ErrorCode.TIMEOUT:a="超时";break;case RongIMLib.ErrorCode.UNKNOWN_ERROR:a="未知错误";break;case RongIMLib.ErrorCode.UNACCEPTABLE_PaROTOCOL_VERSION:a="不可接受的协议版本";break;case RongIMLib.ErrorCode.IDENTIFIER_REJECTED:a="appkey不正确";break;case RongIMLib.ErrorCode.SERVER_UNAVAILABLE:a="服务器不可用";break}console.log(b);debugMsg=a}});RongIMClient.setConnectionStatusListener({onChanged:function(a){switch(a){case RongIMLib.ConnectionStatus.CONNECTED:console.log("链接成功");break;case RongIMLib.ConnectionStatus.CONNECTING:console.log("正在链接");break;case RongIMLib.ConnectionStatus.DISCONNECTED:console.log("断开连接");connectError("IM已断开连接");AbnormalMode();break;case RongIMLib.ConnectionStatus.KICKED_OFFLINE_BY_OTHER_CLIENT:console.log("其他设备登录");connectError("其他设备登录");AbnormalMode();break;case RongIMLib.ConnectionStatus.NETWORK_UNAVAILABLE:console.log("网络不可用");connectError("网络不可用");AbnormalMode();break}}});RongIMClient.setOnReceiveMessageListener({onReceived:function(a){switch(a.messageType){case RongIMClient.MessageType.TextMessage:addMsg(a);break;default:}}});function addMsg(h){var g=typeof(h.content.content)=="string"?JSON.parse(h.content.content):h.content.content;switch(g.type){case 1:var a=merit(g.data.nick,"游客"+random);var c=merit(g.data.text,"支持一下~");c=c.replace(/[<>&"]/g,function(i){return{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[i]});var e=/^([0-9A-Za-z\-_\.]+)@([0-9a-z]+\.[a-z]{2,3}(\.[a-z]{2})?)$/g;var f=/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?/;if(e.test(c)||f.test(c)){c="支持一下~"}else{c=c.replace(/共产党/g,function(l){var j="";for(var k=0;k<l.length;k++){j+="*"}return j})}myDanmu.addDanmu(c,a);break;case 2:break;case 3:break;case 4:myZan.init();break;case 101:myPlayer.pause();break;case 52:var a=merit(g.data.from_user.nick,"游客"+random);var b=merit(g.data.from_user.photo_url,"./share.png");var d={avatar:b,name:a,bundleNum:g.data.bundle_num,giftName:v.gift_list[g.data.gift_id].gift_name,giftImage:v.gift_list[g.data.gift_id].im_url,giftImageGifUrl:v.gift_list[g.data.gift_id].gif_url,type:v.gift_list[g.data.gift_id].combo!=1?"fill":"normal",uid:g.data.gift_id,num:g.data.add_combo+g.data.combo_start};break;case 200:if(g._attachment.show.name=="vote"){var d={vote_option:g._attachment.vote_data.vote_option,name:g._attachment.vote_data.name,top_user:g._attachment.top_user,count_down:g._attachment.vote_data.count_down,vote_id:parseInt(g._attachment.vote_data.vote_id),vote_type:parseInt(g._attachment.vote_data.vote_type)}}if(g._attachment.show.name=="lottery"){var d={type:g._attachment.lottery_data.type,lottery_id:parseInt(g._attachment.lottery_data.lottery_id),title:g._attachment.lottery_data.title,stages:parseInt(g._attachment.lottery_data.stages),price:g._attachment.lottery_data.price,result_data:!$.isEmptyObject(g._attachment.result_data)?g._attachment.result_data:false}}break;case 201:if(g._attachment.show.name=="vote"){var d={vote_option:g._attachment.vote_data.vote_option,name:g._attachment.vote_data.name,top_user:g._attachment.top_user,count_down:g._attachment.vote_data.count_down}}if(g._attachment.show.name=="lottery"){var d={type:g._attachment.lottery_data.type,lottery_id:parseInt(g._attachment.lottery_data.lottery_id),title:g._attachment.lottery_data.title,stages:parseInt(g._attachment.lottery_data.stages),price:g._attachment.lottery_data.price,result_data:!$.isEmptyObject(g._attachment.result_data)?g._attachment.result_data:false}}break;case 205:if(g._attachment.show.name=="vote"){var d={vote_option:g._attachment.vote_data.vote_option,name:g._attachment.vote_data.name,top_user:g._attachment.top_user,count_down:g._attachment.vote_data.count_down,ans_option_id:g._attachment.vote_data.ans_option_id,result:g._attachment.result_data.result}}if(g._attachment.show.name=="lottery"){var d={type:g._attachment.lottery_data.type,lottery_id:parseInt(g._attachment.lottery_data.lottery_id),title:g._attachment.lottery_data.title,stages:parseInt(g._attachment.lottery_data.stages),price:g._attachment.lottery_data.price,result_data:!$.isEmptyObject(g._attachment.result_data)?g._attachment.result_data:false}}break;case 207:if(g._attachment.show.name=="lottery"){}break;case 1010:break;default:break}}function onSendMsg(a){RongIMClient.getInstance().sendMessage(conversationtype,chatroomId,a,{onSuccess:function(b){addMsg(b);$("#send_msg_text").val("")},onError:function(d,b){var c="";switch(d){case RongIMLib.ErrorCode.TIMEOUT:c="超时";break;case RongIMLib.ErrorCode.UNKNOWN_ERROR:c="未知错误";break;case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:c="在黑名单中，无法向对方发送消息";break;case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:c="不在讨论组中";break;case RongIMLib.ErrorCode.NOT_IN_GROUP:c="不在群组中";break;case RongIMLib.ErrorCode.NOT_IN_CHATROOM:c="不在聊天室中";break;default:c=d;break}console.log("发送失败:"+c)}})}function sendMsg(){var f=$("#send_msg_text").val();var d=f.replace(/[<>&"]/g,function(g){return{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[g]});if(d.length<1){return}var a=merit(cookie_nickname,"天天德州用户"+random);a=a.replace(/[<>&"]/g,function(g){return{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[g]});var c=merit(cookie_avatar,"https://web.ttdz.dasheng.tv/images/hall/share.png");var b={type:1,data:{uid:1,nick:a,photo_url:c,text:d}};d=JSON.stringify(b);var e=new RongIMLib.TextMessage({content:d});onSendMsg(e)}function sendComment(){if($("#send_msg_text").val()==null||$("#send_msg_text").val()==""){return false}if(sendTimes==0){timing=true}if(sendTimes>=3&&times<10000){times=0;forbidStart=true;tips("刷屏的不是乖宝宝，歇会吧~")}else{sendTimes++;sendMsg()}}var timing=false;setInterval(function(){if(!timing){return}times+=33;if(times>=10000){sendTimes=times=0;timing=false}tipsed=false},33);function zan(){var a={type:4,data:{color_index:Math.floor(Math.random()*7)+1}};var b=JSON.stringify(a);var c=new RongIMLib.TextMessage({content:b});onSendMsg(c)};